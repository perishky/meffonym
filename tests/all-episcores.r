## ----load.data -------------------------------------------------------------
library(meffonym)

## save methylation dataset
if (!file.exists("GSE145254-meth.csv"))
    source("save-GSE145254.r")

# load the example dataset generated by save-GSE145254.r
library(data.table)
data <- list(
    dnam=as.matrix(fread("GSE145254-meth.csv"),rownames=1),
    samples=as.data.frame(fread("GSE145254-samples.csv")))

str(data)
# List of 2
#  $ dnam   : num [1:866092, 1:23] 0.652 0.92 0.916 0.96 0.965 ...
#   ..- attr(*, "dimnames")=List of 2
#   .. ..$ : chr [1:866092] "cg00000029" "cg00000103" "cg00000109" "cg00000155" ...
#   .. ..$ : chr [1:23] "GSM4310213" "GSM4310214" "GSM4310215" "GSM4310216" ...
#  $ samples:'data.frame':        23 obs. of  7 variables:
#   ..$ Basename : chr [1:23] "201501980023_R01C01" "201501980036_R01C01" "201501970005_R01C01" "201501980023_R02C01" ...
#   ..$ id       : chr [1:23] "GSM4310213" "GSM4310214" "GSM4310215" "GSM4310216" ...
#   ..$ Female   : int [1:23] 1 1 0 1 1 1 1 0 0 1 ...
#   ..$ status   : chr [1:23] "healthy control" "psychiatric case" "healthy control" "healthy control" ...
#   ..$ Age      : int [1:23] 80 60 53 71 69 61 74 52 75 67 ...
#   ..$ ethnicity: chr [1:23] "Black" "Black" "White" "White" ...
#   ..$ Tissue   : chr [1:23] "Whole Blood" "Whole Blood" "Whole Blood" "Whole Blood" ...

# check samples match 
identical(data$samples$id, colnames(data$dnam))
# [1] TRUE

## ----get.gadd.models -------------------------------------------------------------

## pull full information on all models in meffonym
all.models <- meffonym.models(full = T)

table(grepl("episcores", all.models$filename))
#FALSE  TRUE 
#  364   109 

## subset to only the Gadd episcores models
gadd.models <- 
    all.models |>
        subset(grepl("episcores", filename))

#> str(gadd.models)
#'data.frame':   109 obs. of  6 variables:
# $ name       : chr  "ADAMTS" "Adiponectin" "Afamin" "Alpha-L-iduronidase" ...
# $ tissue     : chr  "blood" "blood" "blood" "blood" ...
# $ target     : chr  "ADAMTS" "Adiponectin" "Afamin" "Alpha-L-iduronidase" ...
# $ publication: chr  "10.7554/ELIFE.71802" "10.7554/ELIFE.71802" "10.7554/ELIFE.71802" "10.7554/ELIFE.71802" ...
# $ source     : chr  "https://zenodo.org/record/5869576/files/Predictors_Shiny_by_Groups.csv" "https://zenodo.org/record/5869576/files/Predictors_Shiny_by_Groups.csv" "https://zenodo.org/record/5869576/files/Predictors_Shiny_by_Groups.csv" "https://zenodo.org/record/5869576/files/Predictors_Shiny_by_Groups.csv" ...
# $ filename   : chr  "episcores/ADAMTS.csv" "episcores/Adiponectin.csv" "episcores/Afamin.csv" "episcores/Alpha-L-iduronidase.csv

## ----apply.models -------------------------------------------------------------

## apply all of the Gadd episcores models to the dnam data
ret <- sapply(gadd.models$name, function(.i) 
	        meffonym.score(data$dnam, model = .i), simplify = F)

str(ret[1])
#List of 1
# $ ADAMTS:List of 7
#  ..$ intercept  : num 0
#  ..$ vars       : chr [1:52] "intercept" "cg09458394" "cg00063174" "cg25523753" ...
#  ..$ coefs      : Named num [1:51] -0.000351 -0.00796 -0.00237 -0.020792 -0.002957 ...
#  .. ..- attr(*, "names")= chr [1:51] "cg09458394" "cg00063174" "cg25523753" "cg12678451" ...
#  ..$ description: chr "name:ADAMTS,tissue:blood,target:ADAMTS,publication:10.7554/ELIFE.71802,source:https://zenodo.org/record/5869576"| __truncated__
#  ..$ name       : chr "ADAMTS"
#  ..$ sites      : chr [1:51] "cg00063174" "cg00638202" "cg00988050" "cg01557754" ...
#  ..$ score      : num [1:23] 0.1127 0.1169 0.0862 0.1262 0.1106 ...

## ----get.scores -------------------------------------------------------------)

## extract only the calculated scores from the ret list
scores.raw <- 
	sapply(ret, function(.i){
		out <- data.frame(score = .i$score)
		colnames(out) <- .i$name
		out
	})
# coerce resulting scores to a data frame
scores <- as.data.frame(do.call(cbind, scores.raw))

str(scores)
#'data.frame':   23 obs. of  109 variables:
# $ ADAMTS.ADAMTS                                : num  0.1127 0.1169 0.0862 0.1262 0.1106 ...
# $ Adiponectin.Adiponectin                      : num  -0.0581 -0.072 -0.0906 -0.0563 -0.0546 ...
# $ Afamin.Afamin                                : num  -0.01093 -0.00678 -0.00574 -0.01124 -0.01764 ...
# $ Alpha-L-iduronidase.Alpha-L-iduronidase      : num  0.11 0.106 0.101 0.106 0.116 ...
# $ Aminoacylase-1.Aminoacylase-1                : num  -0.363 -0.334 -0.326 -0.373 -0.364 ...
# $ B2-microglobulin.B2-microglobulin            : num  -0.36 -0.356 -0.392 -0.387 -0.388 ...
# $ BCAM.BCAM                                    : num  0.000533 0.000577 0.000603 0.000607 0.000648 ...
# $ BMP-1.BMP-1                                  : num  0.112 0.125 0.144 0.121 0.119 ...
# $ CCL11.CCL11                                  : num  -0.00529 0.01058 -0.00194 -0.00461 0.00192 ...
# $ CCL17.CCL17                                  : num  -0.462 -0.45 -0.451 -0.465 -0.449 ...
# $ CCL18.CCL18                                  : num  -0.137 -0.132 -0.152 -0.158 -0.151 ...
# $